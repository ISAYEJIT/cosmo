{% extends 'base/base.html' %}

{% block title %}{{ page_title }} - Zarya{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <!-- –ù–∞–≤–∏–≥–∞—Ü–∏–æ–Ω–Ω—ã–µ –∫—Ä–æ—à–∫–∏ -->
    <nav aria-label="breadcrumb" class="mb-4">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{% url 'home' %}">–ì–ª–∞–≤–Ω–∞—è</a></li>
            {% for crumb in breadcrumbs %}
                {% if crumb.url %}
                    <li class="breadcrumb-item"><a href="{% url crumb.url %}">{{ crumb.title }}</a></li>
                {% else %}
                    <li class="breadcrumb-item active" aria-current="page">{{ crumb.title }}</li>
                {% endif %}
            {% endfor %}
        </ol>
    </nav>

    <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <h1 class="h2">
                    üõ∞Ô∏è –°–æ–±—ã—Ç–∏–µ {{ alert.message_code }}-{{ alert.serial_number }}
                    {% if alert_type %}
                        <small class="text-muted">({{ alert_type }})</small>
                    {% endif %}
                </h1>
                <a href="{% url 'noaa_detailed' %}" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left"></i> –ù–∞–∑–∞–¥ –∫ —Å–ø–∏—Å–∫—É
                </a>
            </div>
        </div>
    </div>

    <!-- –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
    <div class="row mb-4">
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title mb-0">
                        <i class="fas fa-exclamation-triangle"></i> 
                        {{ alert.warning_type }}
                    </h3>
                </div>
                <div class="card-body">
                    <div class="row">
                        <!-- –°—Ç–∞—Ç—É—Å -->
                        <div class="col-md-6 mb-3">
                            <h6 class="text-muted">–°—Ç–∞—Ç—É—Å —Å–æ–±—ã—Ç–∏—è</h6>
                            {% if alert.is_active %}
                                <span class="badge bg-danger fs-6">üî¥ –ê–∫—Ç–∏–≤–Ω–æ–µ</span>
                            {% else %}
                                <span class="badge bg-secondary fs-6">‚ö´ –ó–∞–≤–µ—Ä—à–µ–Ω–æ</span>
                            {% endif %}
                        </div>

                        <!-- –®–∫–∞–ª–∞ NOAA -->
                        <div class="col-md-6 mb-3">
                            <h6 class="text-muted">–®–∫–∞–ª–∞ NOAA</h6>
                            {% if alert.severity_level >= 4 %}
                                <span class="badge bg-danger fs-6">{{ alert.noaa_scale|default:"–ù–µ —É–∫–∞–∑–∞–Ω–∞" }}</span>
                            {% elif alert.severity_level >= 3 %}
                                <span class="badge bg-warning fs-6">{{ alert.noaa_scale|default:"–ù–µ —É–∫–∞–∑–∞–Ω–∞" }}</span>
                            {% elif alert.severity_level >= 2 %}
                                <span class="badge bg-info fs-6">{{ alert.noaa_scale|default:"–ù–µ —É–∫–∞–∑–∞–Ω–∞" }}</span>
                            {% else %}
                                <span class="badge bg-success fs-6">{{ alert.noaa_scale|default:"–ù–µ —É–∫–∞–∑–∞–Ω–∞" }}</span>
                            {% endif %}
                        </div>

                        <!-- –£—Å–ª–æ–≤–∏–µ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è -->
                        {% if alert.warning_condition %}
                        <div class="col-md-6 mb-3">
                            <h6 class="text-muted">–£—Å–ª–æ–≤–∏–µ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è</h6>
                            <span class="badge bg-info">{{ alert.warning_condition }}</span>
                        </div>
                        {% endif %}

                        <!-- –°–∫–æ—Ä–æ—Å—Ç—å (–µ—Å–ª–∏ –µ—Å—Ç—å) -->
                        {% if alert.estimated_velocity %}
                        <div class="col-md-6 mb-3">
                            <h6 class="text-muted">–û—Ü–µ–Ω–æ—á–Ω–∞—è —Å–∫–æ—Ä–æ—Å—Ç—å</h6>
                            <span class="fs-5 fw-bold text-primary">{{ alert.estimated_velocity }}</span>
                        </div>
                        {% endif %}
                    </div>

                    <!-- –û–ø–∏—Å–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è -->
                    {% if alert.description %}
                    <div class="mt-4">
                        <h6 class="text-muted">–û–ø–∏—Å–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è</h6>
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            {{ alert.description }}
                        </div>
                    </div>
                    {% endif %}

                    <!-- –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π –ø–æ—Ç–æ–∫ (–¥–ª—è E-—Ç–∏–ø–æ–≤) -->
                    {% if alert.maximum_flux %}
                    <div class="mt-4">
                        <h6 class="text-muted">–ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π –ø–æ—Ç–æ–∫ —ç–ª–µ–∫—Ç—Ä–æ–Ω–æ–≤</h6>
                        <div class="alert alert-primary">
                            <i class="fas fa-bolt me-2"></i>
                            {{ alert.maximum_flux }}
                        </div>
                    </div>
                    {% endif %}

                    <!-- –î–∞–Ω–Ω—ã–µ –ø—Ä–æ–≥–Ω–æ–∑–∞ (–¥–ª—è A-—Ç–∏–ø–æ–≤) -->
                    {% if alert.forecast_data %}
                    <div class="mt-4">
                        <h6 class="text-muted">–î–∞–Ω–Ω—ã–µ –ø—Ä–æ–≥–Ω–æ–∑–∞</h6>
                        <div class="alert alert-secondary">
                            <i class="fas fa-chart-line me-2"></i>
                            <pre class="mb-0" style="white-space: pre-wrap;">{{ alert.forecast_data }}</pre>
                        </div>
                    </div>
                    {% endif %}

                    <!-- –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ –≤–æ–∑–¥–µ–π—Å—Ç–≤–∏—è -->
                    {% if alert.potential_impacts %}
                    <div class="mt-4">
                        <h6 class="text-muted">–ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ –≤–æ–∑–¥–µ–π—Å—Ç–≤–∏—è</h6>
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            {{ alert.potential_impacts }}
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- –ë–æ–∫–æ–≤–∞—è –ø–∞–Ω–µ–ª—å —Å –≤—Ä–µ–º–µ–Ω–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏ -->
        <div class="col-lg-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-clock"></i> –í—Ä–µ–º–µ–Ω–Ω–∞—è –ª–∏–Ω–∏—è
                    </h5>
                </div>
                <div class="card-body">
                    <!-- –í—Ä–µ–º—è –≤—ã–ø—É—Å–∫–∞ -->
                    <div class="timeline-item mb-3">
                        <h6 class="mb-1">
                            <i class="fas fa-broadcast-tower text-primary"></i> 
                            –í—Ä–µ–º—è –≤—ã–ø—É—Å–∫–∞
                        </h6>
                        <p class="mb-0 text-muted">{{ alert.issue_time|date:"d.m.Y H:i" }} UTC</p>
                    </div>

                    <!-- –í—Ä–µ–º—è –Ω–∞—á–∞–ª–∞ -->
                    {% if alert.begin_time %}
                    <div class="timeline-item mb-3">
                        <h6 class="mb-1">
                            <i class="fas fa-play text-success"></i> 
                            –í—Ä–µ–º—è –Ω–∞—á–∞–ª–∞
                        </h6>
                        <p class="mb-0 text-muted">{{ alert.begin_time|date:"d.m.Y H:i" }} UTC</p>
                    </div>
                    {% endif %}

                    <!-- –í—Ä–µ–º—è –º–∞–∫—Å–∏–º—É–º–∞ -->
                    {% if alert.maximum_time %}
                    <div class="timeline-item mb-3">
                        <h6 class="mb-1">
                            <i class="fas fa-arrow-up text-warning"></i> 
                            –í—Ä–µ–º—è –º–∞–∫—Å–∏–º—É–º–∞
                        </h6>
                        <p class="mb-0 text-muted">{{ alert.maximum_time|date:"d.m.Y H:i" }} UTC</p>
                    </div>
                    {% endif %}

                    <!-- –í—Ä–µ–º—è –æ–∫–æ–Ω—á–∞–Ω–∏—è -->
                    {% if alert.end_time %}
                    <div class="timeline-item mb-3">
                        <h6 class="mb-1">
                            <i class="fas fa-stop text-danger"></i> 
                            –í—Ä–µ–º—è –æ–∫–æ–Ω—á–∞–Ω–∏—è
                        </h6>
                        <p class="mb-0 text-muted">{{ alert.end_time|date:"d.m.Y H:i" }} UTC</p>
                    </div>
                    {% endif %}

                    <!-- –î–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —Å -->
                    {% if alert.valid_from %}
                    <div class="timeline-item mb-3">
                        <h6 class="mb-1">
                            <i class="fas fa-calendar-check text-info"></i> 
                            –î–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —Å
                        </h6>
                        <p class="mb-0 text-muted">{{ alert.valid_from|date:"d.m.Y H:i" }} UTC</p>
                    </div>
                    {% endif %}

                    <!-- –î–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –¥–æ -->
                    {% if alert.valid_to %}
                    <div class="timeline-item mb-3">
                        <h6 class="mb-1">
                            <i class="fas fa-calendar-times text-danger"></i> 
                            –î–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –¥–æ
                        </h6>
                        <p class="mb-0 text-muted">{{ alert.valid_to|date:"d.m.Y H:i" }} UTC</p>
                    </div>
                    {% endif %}

                    <!-- –í—Ä–µ–º—è —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–ø–∏—Å–∏ -->
                    <div class="timeline-item">
                        <h6 class="mb-1">
                            <i class="fas fa-database text-secondary"></i> 
                            –î–æ–±–∞–≤–ª–µ–Ω–æ –≤ —Å–∏—Å—Ç–µ–º—É
                        </h6>
                        <p class="mb-0 text-muted">{{ alert.created_at|date:"d.m.Y H:i" }}</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- –ü–æ–ª–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ -->
    <!-- –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-comments"></i> –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ ({{ comments.count }})
                    </h5>
                </div>
                <div class="card-body">
                    <!-- –§–æ—Ä–º–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è -->
                    <form method="post" action="{% url 'add_comment' alert.id %}" class="mb-4">
                        {% csrf_token %}
                        <div class="mb-3">
                            <label for="author_name" class="form-label">–ò–º—è</label>
                            <input type="text" class="form-control" id="author_name" name="author_name" required maxlength="100">
                        </div>
                        <div class="mb-3">
                            <label for="content" class="form-label">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</label>
                            <textarea class="form-control" id="content" name="content" rows="3" required maxlength="1000" placeholder="–û—Å—Ç–∞–≤—å—Ç–µ –≤–∞—à –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π..."></textarea>
                        </div>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-plus"></i> –î–æ–±–∞–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π
                        </button>
                    </form>

                    <!-- –°–ø–∏—Å–æ–∫ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ -->
                    {% if comments %}
                        <div class="comments-list">
                            {% for comment in comments %}
                            <div class="comment-item border-bottom pb-3 mb-3">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div>
                                        <strong>{{ comment.author_name }}</strong>
                                        <small class="text-muted ms-2">{{ comment.created_at|date:"d.m.Y H:i" }}</small>
                                    </div>
                                    <form method="post" action="{% url 'delete_comment' comment.id %}" class="d-inline" 
                                          onsubmit="return confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π?')">
                                        {% csrf_token %}
                                        <button type="submit" class="btn btn-outline-danger btn-sm">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </form>
                                </div>
                                <p class="mb-0 mt-2">{{ comment.content|linebreaks }}</p>
                            </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="text-center text-muted py-4">
                            <i class="fas fa-comment-slash fa-2x mb-2"></i>
                            <p>–ü–æ–∫–∞ –Ω–µ—Ç –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤. –ë—É–¥—å—Ç–µ –ø–µ—Ä–≤—ã–º!</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.timeline-item {
    padding-left: 1.5rem;
    position: relative;
}

.timeline-item::before {
    content: '';
    position: absolute;
    left: 0;
    top: 0.5rem;
    width: 0.5rem;
    height: 0.5rem;
    background-color: #6c757d;
    border-radius: 50%;
}

.timeline-item:not(:last-child)::after {
    content: '';
    position: absolute;
    left: 0.125rem;
    top: 1rem;
    width: 0.25rem;
    height: calc(100% - 0.5rem);
    background-color: #dee2e6;
}
</style>
{% endblock %}
